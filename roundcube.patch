Index: program/include/rcmail.php
===================================================================
--- program/include/rcmail.php	(revision 64)
+++ program/include/rcmail.php	(working copy)
@@ -92,6 +92,12 @@
         if (($basename = basename($_SERVER['SCRIPT_FILENAME'])) && $basename != 'index.php') {
             $this->filename = $basename;
         }
+        
+        if (empty($GLOBALS['NOSESSION'])) {
+            if (!isset($_GET['_nosession'])) {
+                $this->session_init();
+            }
+        }
 
         // start session
         $this->session_init();
@@ -731,7 +737,12 @@
         $this->plugins->exec_hook('session_destroy');
 
         $this->session->kill();
-        $_SESSION = array('language' => $this->user->language, 'temp' => true, 'skin' => $this->config->get('skin'));
+
+        if ($this->session) {
+            $this->session->kill();
+            $_SESSION = array('language' => $this->user->language, 'temp' => true, 'skin' => $this->config->get('skin'));
+        }
+
         $this->user->reset();
     }
 
Index: program/js/app.js
===================================================================
--- program/js/app.js	(revision 64)
+++ program/js/app.js	(working copy)
@@ -1440,7 +1440,7 @@
     else if (delay)
       setTimeout(function() { ref.reload(); }, delay);
     else if (window.location)
-      location.href = this.env.comm_path + (this.env.action ? '&_action='+this.env.action : '');
+      location.href = this.url('', {_extwin: this.env.extwin}); 
   };
 
   // Add variable to GET string, replace old value if exists
@@ -7222,7 +7222,7 @@
   // compose a valid url with the given parameters
   this.url = function(action, query)
   {
-    var querystring = typeof query === 'string' ? '&' + query : '';
+    var querystring = typeof query === 'string' ? query : ''; 
 
     if (typeof action !== 'string')
       query = action;
@@ -7234,12 +7234,12 @@
     else if (this.env.action)
       query._action = this.env.action;
 
-    var base = this.env.comm_path, k, param = {};
+    var url = this.env.comm_path, k, param = {}; 
 
     // overwrite task name
     if (action && action.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)) {
       query._action = RegExp.$2;
-      base = base.replace(/\_task=[a-z0-9_-]+/, '_task='+RegExp.$1);
+      url = url.replace(/\_task=[a-z0-9_-]+/, '_task=' + RegExp.$1);
     }
 
     // remove undefined values
@@ -7248,7 +7248,13 @@
         param[k] = query[k];
     }
 
-    return base + (base.indexOf('?') > -1 ? '&' : '?') + $.param(param) + querystring;
+    if (param = $.param(param)) 
+      url += (url.indexOf('?') > -1 ? '&' : '?') + param; 
+
+    if (querystring) 
+      url += (url.indexOf('?') > -1 ? '&' : '?') + querystring; 
+
+    return url; 
   };
 
   this.redirect = function(url, lock)
@@ -7560,7 +7566,7 @@
     request.abort();
 
     // don't display error message on page unload (#1488547)
-    if (this.unload)
+    if (this.unload || rcmail.env.framed)
       return;
 
     if (request.status && errmsg)
Index: program/js/app.min.js
===================================================================
--- program/js/app.min.js	(revision 64)
+++ program/js/app.min.js	(working copy)
@@ -87,13 +87,13 @@
 break;case "preferences":case "identities":case "responses":case "folders":this.goto_url("settings/"+a);break;case "undo":this.http_request("undo","",this.display_message("","loading"));break;default:h=a.replace(/-/g,"_"),this[h]&&"function"===typeof this[h]&&(f=this[h](b,d,e))}k||!1!==this.triggerEvent("after"+a,b)||(f=!1);this.triggerEvent("actionafter",{props:b,action:a,aborted:k});return!1===f?!1:d?!1:!0};this.enable_command=function(){var a,b,d=Array.prototype.slice.call(arguments),e=d.pop(),
 f;for(b=0;b<d.length;b++)if(f=d[b],"string"===typeof f)this.commands[f]=e,this.set_button(f,e?"act":"pas"),this.triggerEvent("enable-command",{command:f,status:e});else for(a in f)d.push(f[a])};this.command_enabled=function(a){return this.commands[a]};this.set_busy=function(a,b,d){a&&b?(d=this.get_label(b),d==b&&(d="Loading..."),d=this.display_message(d,"loading")):!a&&d&&this.hide_message(d);this.busy=a;this.gui_objects.editform&&this.lock_form(this.gui_objects.editform,a);return d};this.gettext=
 this.get_label=function(a,b){return b&&this.labels[b+"."+a]?this.labels[b+"."+a]:this.labels[a]?this.labels[a]:a};this.switch_task=function(a){if(this.task!==a||"mail"==a){var b=this.get_task_url(a);"mail"==a?b+="&_mbox=INBOX":"logout"!=a||this.env.server_error||(b+="&_token="+this.env.request_token,this.clear_compose_data());this.redirect(b)}};this.get_task_url=function(a,b){b||(b=this.env.comm_path);return b.match(/[?&]_task=[a-zA-Z0-9_-]+/)?b.replace(/_task=[a-zA-Z0-9_-]+/,"_task="+a):b.replace(/\?.*$/,
-"")+"?_task="+a};this.reload=function(a){this.is_framed()?parent.rcmail.reload(a):a?setTimeout(function(){g.reload()},a):window.location&&(location.href=this.env.comm_path+(this.env.action?"&_action="+this.env.action:""))};this.add_url=function(a,b,d){d=urlencode(d);if(/(\?.*)$/.test(a)){var e=RegExp.$1,f=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)"),e=f.test(e)?e.replace(f,RegExp.$2+b+"="+d):e+("&"+b+"="+d);return a.replace(/(\?.*)$/,e)}return a+"?"+b+"="+d};this.is_framed=function(){return this.env.framed&&
-parent.rcmail&&parent.rcmail!=this&&"function"==typeof parent.rcmail.command};this.save_pref=function(a){var b={_name:a.name,_value:a.value};a.session&&(b._session=a.session);a.env&&(this.env[a.env]=a.value);this.http_post("save-pref",b)};this.html_identifier=function(a,b){return b?this.html_identifier_encode(a):String(a).replace(this.identifier_expr,"_")};this.html_identifier_encode=function(a){return Base64.encode(String(a)).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")};this.html_identifier_decode=
-function(a){for(a=String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)};this.drag_menu=function(a,b){var d=rcube_event.get_modifier(a),e=this.gui_objects.dragmenu;return e&&d==SHIFT_KEY&&this.commands.copy?(d=rcube_event.get_mouse_pos(a),this.env.drag_target=b,this.show_menu(this.gui_objects.dragmenu.id,!0,a),$(e).css({top:d.y-10+"px",left:d.x-10+"px"}),!0):!1};this.drag_menu_action=function(a){var b=this.gui_objects.dragmenu;b&&$(b).hide();this.command(a,this.env.drag_target);
-this.env.drag_target=null};this.drag_start=function(a){this.drag_active=!0;this.preview_timer&&clearTimeout(this.preview_timer);this.preview_read_timer&&clearTimeout(this.preview_read_timer);this.treelist&&this.treelist.drag_start()};this.drag_end=function(a){var b,d;this.treelist&&this.treelist.drag_end();if(b=this.message_list)d=this.env.mailboxes;else if(b=this.contact_list)d=this.env.contactfolders;this.drag_active&&d&&this.env.last_folder_target&&(d=d[this.env.last_folder_target],b.draglayer.hide(),
-this.contact_list?this.contacts_drag_menu(a,d)||this.command("move",d):this.drag_menu(a,d)||this.command("move",d));this.drag_active=!1;this.env.last_folder_target=null};this.drag_move=function(a){if(this.gui_objects.folderlist){var b,d,e="draglayernormal";a=rcube_event.get_mouse_pos(a);this.contact_list&&this.contact_list.draglayer&&(d=this.contact_list.draglayer.attr("class"));this.treelist&&(b=this.treelist.intersects(a,!0))?(this.env.last_folder_target=b,e="draglayer"+(1<this.check_droptarget(b)?
-"copy":"normal")):this.env.last_folder_target=null;e!=d&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",e)}};this.collapse_folder=function(a){this.treelist&&this.treelist.toggle(a)};this.folder_collapsed=function(a){var b="addressbook"==this.env.task?"collapsed_abooks":"collapsed_folders",d=this.env[b];if(a.collapsed)this.env[b]=this.env[b]+"&"+urlencode(a.id)+"&",!a.virtual&&this.env.mailbox&&this.env.mailbox.startsWith(name+this.env.delimiter)&&this.command("list",
-name);else{var e=new RegExp("&"+urlencode(a.id)+"&");this.env[b]=this.env[b].replace(e,"")}this.drag_active||(d!==this.env[b]&&this.command("save-pref",{name:b,value:this.env[b]}),this.env.unread_counts&&this.set_unread_count_display(a.id,!1))};this.doc_mouse_up=function(a){var b,d=rcube_event.get_target(a);if(!$(d).closest(".ui-dialog, .ui-widget-overlay").length){window.rcube_list_widget&&rcube_list_widget._instances.length&&$.each(rcube_list_widget._instances,function(b,d){d&&!rcube_mouse_is_over(a,
+"")+"?_task="+a};this.reload=function(a){this.is_framed()?parent.rcmail.reload(a):a?setTimeout(function(){g.reload()},a):window.location&&(location.href=this.url("",{_extwin:this.env.extwin}))};this.add_url=function(a,b,d){d=urlencode(d);if(/(\?.*)$/.test(a)){var e=RegExp.$1,f=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)"),e=f.test(e)?e.replace(f,RegExp.$2+b+"="+d):e+("&"+b+"="+d);return a.replace(/(\?.*)$/,e)}return a+"?"+b+"="+d};this.is_framed=function(){return this.env.framed&&parent.rcmail&&parent.rcmail!=
+this&&"function"==typeof parent.rcmail.command};this.save_pref=function(a){var b={_name:a.name,_value:a.value};a.session&&(b._session=a.session);a.env&&(this.env[a.env]=a.value);this.http_post("save-pref",b)};this.html_identifier=function(a,b){return b?this.html_identifier_encode(a):String(a).replace(this.identifier_expr,"_")};this.html_identifier_encode=function(a){return Base64.encode(String(a)).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")};this.html_identifier_decode=function(a){for(a=
+String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)};this.drag_menu=function(a,b){var d=rcube_event.get_modifier(a),e=this.gui_objects.dragmenu;return e&&d==SHIFT_KEY&&this.commands.copy?(d=rcube_event.get_mouse_pos(a),this.env.drag_target=b,this.show_menu(this.gui_objects.dragmenu.id,!0,a),$(e).css({top:d.y-10+"px",left:d.x-10+"px"}),!0):!1};this.drag_menu_action=function(a){var b=this.gui_objects.dragmenu;b&&$(b).hide();this.command(a,this.env.drag_target);this.env.drag_target=
+null};this.drag_start=function(a){this.drag_active=!0;this.preview_timer&&clearTimeout(this.preview_timer);this.preview_read_timer&&clearTimeout(this.preview_read_timer);this.treelist&&this.treelist.drag_start()};this.drag_end=function(a){var b,d;this.treelist&&this.treelist.drag_end();if(b=this.message_list)d=this.env.mailboxes;else if(b=this.contact_list)d=this.env.contactfolders;this.drag_active&&d&&this.env.last_folder_target&&(d=d[this.env.last_folder_target],b.draglayer.hide(),this.contact_list?
+this.contacts_drag_menu(a,d)||this.command("move",d):this.drag_menu(a,d)||this.command("move",d));this.drag_active=!1;this.env.last_folder_target=null};this.drag_move=function(a){if(this.gui_objects.folderlist){var b,d,e="draglayernormal";a=rcube_event.get_mouse_pos(a);this.contact_list&&this.contact_list.draglayer&&(d=this.contact_list.draglayer.attr("class"));this.treelist&&(b=this.treelist.intersects(a,!0))?(this.env.last_folder_target=b,e="draglayer"+(1<this.check_droptarget(b)?"copy":"normal")):
+this.env.last_folder_target=null;e!=d&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",e)}};this.collapse_folder=function(a){this.treelist&&this.treelist.toggle(a)};this.folder_collapsed=function(a){var b="addressbook"==this.env.task?"collapsed_abooks":"collapsed_folders",d=this.env[b];if(a.collapsed)this.env[b]=this.env[b]+"&"+urlencode(a.id)+"&",!a.virtual&&this.env.mailbox&&this.env.mailbox.startsWith(name+this.env.delimiter)&&this.command("list",name);
+else{var e=new RegExp("&"+urlencode(a.id)+"&");this.env[b]=this.env[b].replace(e,"")}this.drag_active||(d!==this.env[b]&&this.command("save-pref",{name:b,value:this.env[b]}),this.env.unread_counts&&this.set_unread_count_display(a.id,!1))};this.doc_mouse_up=function(a){var b,d=rcube_event.get_target(a);if(!$(d).closest(".ui-dialog, .ui-widget-overlay").length){window.rcube_list_widget&&rcube_list_widget._instances.length&&$.each(rcube_list_widget._instances,function(b,d){d&&!rcube_mouse_is_over(a,
 d.list.parentNode)&&d.blur()});if(this.buttons_sel){for(b in this.buttons_sel)"function"!==typeof b&&this.button_out(this.buttons_sel[b],b);this.buttons_sel={}}setTimeout(function(a){var b,h,n,k,m=$(d).parents();for(k=g.menu_stack.length-1;0<=k;k--)n=g.menu_stack[k],b=$("#"+n),!b.is(":visible")||d==b.data("opener")||d==b.get(0)||m.is(b.data("opener"))||n==h||"true"==b.attr("data-editable")&&$(d).parents("#"+n).length||"true"==b.attr("data-sticky")&&rcube_mouse_is_over(a,b.get(0))||g.hide_menu(n,a),
 h=b.data("parent")},10,a)}};this.doc_keypress=function(a){var b=function(a){var b,d=0>a?"prevAll":"nextAll",e=0>a?"last":"first";return g.focused_menu&&(b=$("#"+g.focused_menu))?(a=b.find(":focus").closest("li")[d](":has(:not([aria-disabled=true]))").find("a,input")[e](),a.length||(a=b.find(":focus").closest("ul")[d](":has(:not([aria-disabled=true]))").find("a,input")[e]()),a.focus().length):0},d=a.target||{},e=rcube_event.get_keycode(a);rcube_event._last_keyboard_event=a;if(27!=a.keyCode&&(!this.menu_keyboard_active||
 "TEXTAREA"==d.nodeName||"SELECT"==d.nodeName))return!0;switch(e){case 38:case 40:case 63232:case 63233:return b(38==e||63232==e?-1:1),rcube_event.cancel(a);case 9:return this.focused_menu&&(d=rcube_event.get_modifier(a),b(d==SHIFT_KEY?-1:1)||this.hide_menu(this.focused_menu,a)),rcube_event.cancel(a);case 27:this.menu_stack.length&&this.hide_menu(this.menu_stack[this.menu_stack.length-1],a)}return!0};this.msglist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);this.preview_read_timer&&
@@ -270,27 +270,27 @@
 props:{menu:this.menu_stack[f]},originalEvent:b}),this.menu_stack[f]==a&&(f=-1,d.data("opener")&&($(d.data("opener")).attr("aria-expanded","false"),e&&d.data("opener").focus())),this.menu_stack.pop();this.menu_stack.length&&e?(this.menu_keyboard_active=!0,this.focused_menu=$.last(this.menu_stack),d&&d.data("opener")||$("#"+this.focused_menu).find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus()):(this.focused_menu=null,this.menu_keyboard_active=!1)}else this.triggerEvent("menu-close",
 {name:a,props:{menu:a},originalEvent:b})};this.element_position=function(a,b){b=$(b);var d=$(window),e=b.outerWidth(),f=b.outerHeight(),h=b.data("menu-pos"),g=d.height(),k=$(a).height(),m=$(a).width(),l=b.offset(),p=l.top,l=l.left+e;"bottom"==h?(p+=f,l-=e):l-=5;p+k>g&&(p-=k-f,0>p&&(p=Math.max(0,(g-k)/2)));l+m>d.width()&&(l-=m+e);a.css({left:l+"px",top:p+"px"})};this.editor_init=function(a,b){this.editor=new rcube_text_editor(a,b)};this.html2plain=function(a,b){return this.format_converter(a,"html",
 b)};this.plain2html=function(a,b){return this.format_converter(a,"plain",b)};this.format_converter=function(a,b,d){if(!a||"html"==b&&!a.replace(/<[^>]+>|&nbsp;|\xC2\xA0|\s/g,"").length||"html"!=b&&!a.replace(/\xC2\xA0|\s/g,"").length)return d&&setTimeout(function(){d("")},50),!0;var e=this.env.editor_warned||confirm(this.get_label("editorwarning"));this.env.editor_warned=!0;if(!e)return!1;b="?_task=utils&_action="+("html"==b?"html2text":"text2html");var f=this.set_busy(!0,"converting");this.log("HTTP POST: "+
-b);$.ajax({type:"POST",url:b,data:a,contentType:"application/octet-stream",error:function(a,b,d){g.http_error(a,b,d,f)},success:function(a){g.set_busy(!1,null,f);d&&d(a)}});return!0};this.url=function(a,b){var d="string"===typeof b?"&"+b:"";"string"!==typeof a?b=a:b&&"object"===typeof b||(b={});a?b._action=a:this.env.action&&(b._action=this.env.action);var e=this.env.comm_path,f,g={};a&&a.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)&&(b._action=RegExp.$2,e=e.replace(/\_task=[a-z0-9_-]+/,"_task="+RegExp.$1));
-for(f in b)void 0!==b[f]&&null!==b[f]&&(g[f]=b[f]);return e+(-1<e.indexOf("?")?"&":"?")+$.param(g)+d};this.redirect=function(a,b){(b||null===b)&&this.set_busy(!0);this.is_framed()?parent.rcmail.redirect(a,b):(this.env.extwin&&("string"==typeof a?a+=(0>a.indexOf("?")?"?":"&")+"_extwin=1":a._extwin=1),this.location_href(a,window))};this.goto_url=function(a,b,d){this.redirect(this.url(a,b),d)};this.location_href=function(a,b,d){d&&this.lock_frame();"object"==typeof a&&(a=this.env.comm_path+"&"+$.param(a));
-bw.ie&&b==window?$("<a>").attr("href",a).appendTo(document.body).get(0).click():b.location.href=a;this.start_keepalive()};this.update_state=function(a){window.history.replaceState&&window.history.replaceState({},document.title,rcmail.url("",a))};this.http_request=function(a,b,d){"object"!==typeof b&&(b=rcube_parse_query(b));b._remote=1;b._unlock=d?d:0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;void 0!==e&&(b=e,b._action&&(a=b._action,delete b._action));
-b=this.url(a,b);this.log("HTTP GET: "+b);this.start_keepalive();return $.ajax({type:"GET",url:b,dataType:"json",success:function(a){g.http_response(a)},error:function(b,e,n){g.http_error(b,e,n,d,a)}})};this.http_post=function(a,b,d){"object"!==typeof b&&(b=rcube_parse_query(b));b._remote=1;b._unlock=d?d:0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;void 0!==e&&(b=e,b._action&&(a=b._action,delete b._action));e=this.url(a);this.log("HTTP POST: "+
-e);this.start_keepalive();return $.ajax({type:"POST",url:e,data:b,dataType:"json",success:function(a){g.http_response(a)},error:function(b,e,n){g.http_error(b,e,n,d,a)}})};this.abort_request=function(a){a.request&&a.request.abort();a.lock&&this.set_busy(!1,null,a.lock)};this.http_response=function(a){if(a){a.unlock&&this.set_busy(!1);this.triggerEvent("responsebefore",{response:a});this.triggerEvent("responsebefore"+a.action,{response:a});a.env&&this.set_env(a.env);if("object"===typeof a.texts)for(var b in a.texts)"string"===
-typeof a.texts[b]&&this.add_label(b,a.texts[b]);a.exec&&(this.log(a.exec),eval(a.exec));if(a.callbacks&&a.callbacks.length)for(b=0;b<a.callbacks.length;b++)this.triggerEvent(a.callbacks[b][0],a.callbacks[b][1]);switch(a.action){case "delete":if("addressbook"==this.task){var d;b=this.contact_list.get_selection();d=!1;b&&this.contact_list.rows[b]&&(d=""==this.env.source?(d=String(b).replace(/^[^-]+-/,""))&&this.env.address_sources[d]&&!this.env.address_sources[d].readonly:!this.env.address_sources[this.env.source].readonly);
-this.enable_command("compose",b&&this.contact_list.rows[b]);this.enable_command("delete","edit",d);this.enable_command("export",this.contact_list&&0<this.contact_list.rowcount);this.enable_command("export-selected","print",!1)}case "move":"show"==this.env.action?(this.enable_command(this.env.message_commands,!0),this.env.list_post||this.enable_command("reply-list",!1)):"addressbook"==this.task&&this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount});case "purge":case "expunge":"mail"==
-this.task&&(this.env.exists||(this.env.contentframe&&this.show_contentframe(!1),this.enable_command(this.env.message_commands,"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",!1)),this.message_list&&this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:this.message_list.rowcount}));break;case "refresh":case "check-recent":$.each(this.env.recent_flags||{},function(a,b){g.set_message(a,"deleted",b.deleted);g.set_message(a,"replied",b.answered);g.set_message(a,
-"unread",!b.seen);g.set_message(a,"forwarded",b.forwarded);g.set_message(a,"flagged",b.flagged)}),delete this.env.recent_flags;case "getunread":case "search":this.env.qsearch=null;case "list":if("mail"==this.task){if(d=this.is_multifolder_listing(),this.enable_command("show","select-all","select-none",0<this.env.messagecount),this.enable_command("expunge",this.env.exists&&!d),this.enable_command("purge",this.purge_mailbox_test()&&!d),this.enable_command("import-messages",!d),this.enable_command("expand-all",
-"expand-unread","collapse-all",this.env.threading&&this.env.messagecount&&!d),("list"==a.action||"search"==a.action)&&this.message_list){var e=this.message_list;if(b=this.env.list_uid)e.rows[b]||(b+="-"+this.env.mailbox),e.rows[b]&&e.select(b),delete this.env.list_uid;this.enable_command("set-listmode",this.env.threads&&!d);0<e.rowcount&&e.focus();this.msglist_select(e);this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:e.rowcount})}}else"addressbook"==this.task&&(this.enable_command("export",
-this.contact_list&&0<this.contact_list.rowcount),"list"==a.action||"search"==a.action)&&(this.enable_command("search-create",""==this.env.source),this.enable_command("search-delete",this.env.search_id),this.update_group_commands(),0<this.contact_list.rowcount&&this.contact_list.focus(),this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount}));break;case "list-contacts":case "search-contacts":this.contact_list&&0<this.contact_list.rowcount&&this.contact_list.focus()}a.unlock&&
-this.hide_message(a.unlock);this.triggerEvent("responseafter",{response:a});this.triggerEvent("responseafter"+a.action,{response:a});this.start_keepalive()}};this.http_error=function(a,b,d,e,f){d=a.statusText;this.set_busy(!1,null,e);a.abort();this.unload||(a.status&&d?this.display_message(this.get_label("servererror")+" ("+d+")","error"):"timeout"==b?this.display_message(this.get_label("requesttimedout"),"error"):0==a.status&&"abort"!=b&&this.display_message(this.get_label("connerror"),"error"),
-(b=a.getResponseHeader("Location"))&&"compose"!=this.env.action&&this.redirect(b),403==a.status?(this.is_framed()?parent:window).location.reload():"keep-alive"==f&&setTimeout(function(){g.keep_alive();g.start_keepalive()},3E4))};this.session_error=function(a){this.env.server_error=401;"compose"==this.env.action?(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0):a&&setTimeout(function(){g.redirect(a,!0)},2E3)};this.iframe_loaded=function(a){this.set_busy(!1,null,a);this.submit_timer&&
-clearTimeout(this.submit_timer)};this.multi_thread_http_request=function(a){var b,d,e=(new Date).getTime(),f=a.threads||1;a.reqid=e;a.running=0;a.requests=[];a.result=[];a._items=$.extend([],a.items);a.lock||(a.lock=this.display_message(this.get_label("loading"),"loading"));this.http_request_jobs[e]=a;for(b=0;b<f;b++){d=a._items.shift();if(void 0===d)break;a.running++;a.requests.push(this.multi_thread_send_request(a,d))}return e};this.multi_thread_send_request=function(a,b){var d,e,f;if(a.postdata){e=
-{};for(d in a.postdata)e[d]=String(a.postdata[d]).replace("%s",b);e._reqid=a.reqid}else if("string"==typeof a.query)f=a.query.replace("%s",b),f+="&_reqid="+a.reqid;else if("object"==typeof a.query&&a.query){f={};for(d in a.query)f[d]=String(a.query[d]).replace("%s",b);f._reqid=a.reqid}return e?this.http_post(a.action,e):this.http_request(a.action,f)};this.multi_thread_http_response=function(a,b){var d=this.http_request_jobs[b];if(!(!d||0>=d.running||d.cancelled)){d.running--;if(d.onresponse&&"function"==
-typeof d.onresponse)d.onresponse(a);d.result=$.extend(d.result,a);var e=d._items.shift();void 0!==e?(d.running++,d.requests.push(this.multi_thread_send_request(d,e))):0==d.running&&(d.whendone&&"function"==typeof d.whendone&&d.whendone(d.result),this.set_busy(!1,"",d.lock),delete this.http_request_jobs[b])}};this.multi_thread_request_abort=function(a){if(a=this.http_request_jobs[a]){for(var b=0;0<a.running&&b<a.requests.length;b++)a.requests[b].abort&&a.requests[b].abort();a.running=0;a.cancelled=
-!0;this.set_busy(!1,"",a.lock)}};this.async_upload_form=function(a,b,d){var e=(new Date).getTime(),f="rcmupload"+e,g=this.async_upload_form_frame(f);if(this.env.upload_progress_name){var n=this.env.upload_progress_name,k=$("input[name="+n+"]",a);k.length||(k=$("<input>").attr({type:"hidden",name:n}),k.prependTo(a));k.val(e)}g.bind("load",{ts:e},d);$(a).attr({target:f,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:e,_from:this.env.action}),method:"POST"}).attr(a.encoding?"encoding":"enctype",
-"multipart/form-data").submit();return f};this.async_upload_form_frame=function(a){return $("<iframe>").attr({name:a,style:"border: none; width: 0; height: 0; visibility: hidden"}).appendTo(document.body)};this.document_drag_hover=function(a,b){a.preventDefault();$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")};this.file_drag_hover=function(a,b){a.preventDefault();a.stopPropagation();$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")};this.file_dropped=function(a){this.file_drag_hover(a,
-!1);var b=a.target.files||a.dataTransfer.files,d=window.FormData?new FormData:null,e=(this.env.filedrop.fieldname||"_file")+(this.env.filedrop.single?"":"[]"),f="------multipartformboundary"+(new Date).getTime(),h="--"+f+"\r\n";if(b&&b.length)for(var n=function(){var a=1<b.length,e=(new Date).getTime(),a="<span>"+(a?g.get_label("uploadingmany"):b[0].name)+"</span>";g.add2attachment_list(e,{name:"",html:a,classname:"uploading",complete:!1})||(g.file_upload_id=g.set_busy(!0,"uploading"));h+="--"+f+
-"--\r\n";$.ajax({type:"POST",dataType:"json",url:g.url(g.env.filedrop.action||"upload",{_id:g.env.compose_id||g.env.cid||"",_uploadid:e,_remote:1,_from:g.env.action}),contentType:d?!1:"multipart/form-data; boundary="+f,processData:!1,timeout:0,data:d||h,headers:{"X-Roundcube-Request":g.env.request_token},xhr:function(){var a=jQuery.ajaxSettings.xhr();!d&&a.sendAsBinary&&(a.send=a.sendAsBinary);return a},success:function(a){g.http_response(a)},error:function(a,b,d){g.http_error(a,b,d,null,"attachment")}})},
-k=this.env.filedrop.single?0:b.length-1,m=a=0,l;a<=k&&(l=b[m]);m++)if(l.name||(l.name=l.fileName),l.size||(l.size=l.fileSize),l.type||(l.type="application/octet-stream"),!d&&/[^\x20-\x7E]/.test(l.name)&&(l.name_bin=unescape(encodeURIComponent(l.name))),!this.env.filedrop.filter||l.type.match(new RegExp(this.env.filedrop.filter))){if(d){if(d.append(e,l),a==k)return n()}else if(window.FileReader){var p=new FileReader;p.onload=function(a,b){return function(d){h+='Content-Disposition: form-data; name="'+
+b);$.ajax({type:"POST",url:b,data:a,contentType:"application/octet-stream",error:function(a,b,d){g.http_error(a,b,d,f)},success:function(a){g.set_busy(!1,null,f);d&&d(a)}});return!0};this.url=function(a,b){var d="string"===typeof b?b:"";"string"!==typeof a?b=a:b&&"object"===typeof b||(b={});a?b._action=a:this.env.action&&(b._action=this.env.action);var e=this.env.comm_path,f,g={};a&&a.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)&&(b._action=RegExp.$2,e=e.replace(/\_task=[a-z0-9_-]+/,"_task="+RegExp.$1));
+for(f in b)void 0!==b[f]&&null!==b[f]&&(g[f]=b[f]);if(g=$.param(g))e+=(-1<e.indexOf("?")?"&":"?")+g;d&&(e+=(-1<e.indexOf("?")?"&":"?")+d);return e};this.redirect=function(a,b){(b||null===b)&&this.set_busy(!0);this.is_framed()?parent.rcmail.redirect(a,b):(this.env.extwin&&("string"==typeof a?a+=(0>a.indexOf("?")?"?":"&")+"_extwin=1":a._extwin=1),this.location_href(a,window))};this.goto_url=function(a,b,d){this.redirect(this.url(a,b),d)};this.location_href=function(a,b,d){d&&this.lock_frame();"object"==
+typeof a&&(a=this.env.comm_path+"&"+$.param(a));bw.ie&&b==window?$("<a>").attr("href",a).appendTo(document.body).get(0).click():b.location.href=a;this.start_keepalive()};this.update_state=function(a){window.history.replaceState&&window.history.replaceState({},document.title,rcmail.url("",a))};this.http_request=function(a,b,d){"object"!==typeof b&&(b=rcube_parse_query(b));b._remote=1;b._unlock=d?d:0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),
+!1;void 0!==e&&(b=e,b._action&&(a=b._action,delete b._action));b=this.url(a,b);this.log("HTTP GET: "+b);this.start_keepalive();return $.ajax({type:"GET",url:b,dataType:"json",success:function(a){g.http_response(a)},error:function(b,e,n){g.http_error(b,e,n,d,a)}})};this.http_post=function(a,b,d){"object"!==typeof b&&(b=rcube_parse_query(b));b._remote=1;b._unlock=d?d:0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;void 0!==e&&(b=e,b._action&&
+(a=b._action,delete b._action));e=this.url(a);this.log("HTTP POST: "+e);this.start_keepalive();return $.ajax({type:"POST",url:e,data:b,dataType:"json",success:function(a){g.http_response(a)},error:function(b,e,n){g.http_error(b,e,n,d,a)}})};this.abort_request=function(a){a.request&&a.request.abort();a.lock&&this.set_busy(!1,null,a.lock)};this.http_response=function(a){if(a){a.unlock&&this.set_busy(!1);this.triggerEvent("responsebefore",{response:a});this.triggerEvent("responsebefore"+a.action,{response:a});
+a.env&&this.set_env(a.env);if("object"===typeof a.texts)for(var b in a.texts)"string"===typeof a.texts[b]&&this.add_label(b,a.texts[b]);a.exec&&(this.log(a.exec),eval(a.exec));if(a.callbacks&&a.callbacks.length)for(b=0;b<a.callbacks.length;b++)this.triggerEvent(a.callbacks[b][0],a.callbacks[b][1]);switch(a.action){case "delete":if("addressbook"==this.task){var d;b=this.contact_list.get_selection();d=!1;b&&this.contact_list.rows[b]&&(d=""==this.env.source?(d=String(b).replace(/^[^-]+-/,""))&&this.env.address_sources[d]&&
+!this.env.address_sources[d].readonly:!this.env.address_sources[this.env.source].readonly);this.enable_command("compose",b&&this.contact_list.rows[b]);this.enable_command("delete","edit",d);this.enable_command("export",this.contact_list&&0<this.contact_list.rowcount);this.enable_command("export-selected","print",!1)}case "move":"show"==this.env.action?(this.enable_command(this.env.message_commands,!0),this.env.list_post||this.enable_command("reply-list",!1)):"addressbook"==this.task&&this.triggerEvent("listupdate",
+{folder:this.env.source,rowcount:this.contact_list.rowcount});case "purge":case "expunge":"mail"==this.task&&(this.env.exists||(this.env.contentframe&&this.show_contentframe(!1),this.enable_command(this.env.message_commands,"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",!1)),this.message_list&&this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:this.message_list.rowcount}));break;case "refresh":case "check-recent":$.each(this.env.recent_flags||
+{},function(a,b){g.set_message(a,"deleted",b.deleted);g.set_message(a,"replied",b.answered);g.set_message(a,"unread",!b.seen);g.set_message(a,"forwarded",b.forwarded);g.set_message(a,"flagged",b.flagged)}),delete this.env.recent_flags;case "getunread":case "search":this.env.qsearch=null;case "list":if("mail"==this.task){if(d=this.is_multifolder_listing(),this.enable_command("show","select-all","select-none",0<this.env.messagecount),this.enable_command("expunge",this.env.exists&&!d),this.enable_command("purge",
+this.purge_mailbox_test()&&!d),this.enable_command("import-messages",!d),this.enable_command("expand-all","expand-unread","collapse-all",this.env.threading&&this.env.messagecount&&!d),("list"==a.action||"search"==a.action)&&this.message_list){var e=this.message_list;if(b=this.env.list_uid)e.rows[b]||(b+="-"+this.env.mailbox),e.rows[b]&&e.select(b),delete this.env.list_uid;this.enable_command("set-listmode",this.env.threads&&!d);0<e.rowcount&&e.focus();this.msglist_select(e);this.triggerEvent("listupdate",
+{folder:this.env.mailbox,rowcount:e.rowcount})}}else"addressbook"==this.task&&(this.enable_command("export",this.contact_list&&0<this.contact_list.rowcount),"list"==a.action||"search"==a.action)&&(this.enable_command("search-create",""==this.env.source),this.enable_command("search-delete",this.env.search_id),this.update_group_commands(),0<this.contact_list.rowcount&&this.contact_list.focus(),this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount}));break;case "list-contacts":case "search-contacts":this.contact_list&&
+0<this.contact_list.rowcount&&this.contact_list.focus()}a.unlock&&this.hide_message(a.unlock);this.triggerEvent("responseafter",{response:a});this.triggerEvent("responseafter"+a.action,{response:a});this.start_keepalive()}};this.http_error=function(a,b,d,e,f){d=a.statusText;this.set_busy(!1,null,e);a.abort();this.unload||rcmail.env.framed||(a.status&&d?this.display_message(this.get_label("servererror")+" ("+d+")","error"):"timeout"==b?this.display_message(this.get_label("requesttimedout"),"error"):
+0==a.status&&"abort"!=b&&this.display_message(this.get_label("connerror"),"error"),(b=a.getResponseHeader("Location"))&&"compose"!=this.env.action&&this.redirect(b),403==a.status?(this.is_framed()?parent:window).location.reload():"keep-alive"==f&&setTimeout(function(){g.keep_alive();g.start_keepalive()},3E4))};this.session_error=function(a){this.env.server_error=401;"compose"==this.env.action?(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0):a&&setTimeout(function(){g.redirect(a,
+!0)},2E3)};this.iframe_loaded=function(a){this.set_busy(!1,null,a);this.submit_timer&&clearTimeout(this.submit_timer)};this.multi_thread_http_request=function(a){var b,d,e=(new Date).getTime(),f=a.threads||1;a.reqid=e;a.running=0;a.requests=[];a.result=[];a._items=$.extend([],a.items);a.lock||(a.lock=this.display_message(this.get_label("loading"),"loading"));this.http_request_jobs[e]=a;for(b=0;b<f;b++){d=a._items.shift();if(void 0===d)break;a.running++;a.requests.push(this.multi_thread_send_request(a,
+d))}return e};this.multi_thread_send_request=function(a,b){var d,e,f;if(a.postdata){e={};for(d in a.postdata)e[d]=String(a.postdata[d]).replace("%s",b);e._reqid=a.reqid}else if("string"==typeof a.query)f=a.query.replace("%s",b),f+="&_reqid="+a.reqid;else if("object"==typeof a.query&&a.query){f={};for(d in a.query)f[d]=String(a.query[d]).replace("%s",b);f._reqid=a.reqid}return e?this.http_post(a.action,e):this.http_request(a.action,f)};this.multi_thread_http_response=function(a,b){var d=this.http_request_jobs[b];
+if(!(!d||0>=d.running||d.cancelled)){d.running--;if(d.onresponse&&"function"==typeof d.onresponse)d.onresponse(a);d.result=$.extend(d.result,a);var e=d._items.shift();void 0!==e?(d.running++,d.requests.push(this.multi_thread_send_request(d,e))):0==d.running&&(d.whendone&&"function"==typeof d.whendone&&d.whendone(d.result),this.set_busy(!1,"",d.lock),delete this.http_request_jobs[b])}};this.multi_thread_request_abort=function(a){if(a=this.http_request_jobs[a]){for(var b=0;0<a.running&&b<a.requests.length;b++)a.requests[b].abort&&
+a.requests[b].abort();a.running=0;a.cancelled=!0;this.set_busy(!1,"",a.lock)}};this.async_upload_form=function(a,b,d){var e=(new Date).getTime(),f="rcmupload"+e,g=this.async_upload_form_frame(f);if(this.env.upload_progress_name){var n=this.env.upload_progress_name,k=$("input[name="+n+"]",a);k.length||(k=$("<input>").attr({type:"hidden",name:n}),k.prependTo(a));k.val(e)}g.bind("load",{ts:e},d);$(a).attr({target:f,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:e,_from:this.env.action}),method:"POST"}).attr(a.encoding?
+"encoding":"enctype","multipart/form-data").submit();return f};this.async_upload_form_frame=function(a){return $("<iframe>").attr({name:a,style:"border: none; width: 0; height: 0; visibility: hidden"}).appendTo(document.body)};this.document_drag_hover=function(a,b){a.preventDefault();$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")};this.file_drag_hover=function(a,b){a.preventDefault();a.stopPropagation();$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")};this.file_dropped=
+function(a){this.file_drag_hover(a,!1);var b=a.target.files||a.dataTransfer.files,d=window.FormData?new FormData:null,e=(this.env.filedrop.fieldname||"_file")+(this.env.filedrop.single?"":"[]"),f="------multipartformboundary"+(new Date).getTime(),h="--"+f+"\r\n";if(b&&b.length)for(var n=function(){var a=1<b.length,e=(new Date).getTime(),a="<span>"+(a?g.get_label("uploadingmany"):b[0].name)+"</span>";g.add2attachment_list(e,{name:"",html:a,classname:"uploading",complete:!1})||(g.file_upload_id=g.set_busy(!0,
+"uploading"));h+="--"+f+"--\r\n";$.ajax({type:"POST",dataType:"json",url:g.url(g.env.filedrop.action||"upload",{_id:g.env.compose_id||g.env.cid||"",_uploadid:e,_remote:1,_from:g.env.action}),contentType:d?!1:"multipart/form-data; boundary="+f,processData:!1,timeout:0,data:d||h,headers:{"X-Roundcube-Request":g.env.request_token},xhr:function(){var a=jQuery.ajaxSettings.xhr();!d&&a.sendAsBinary&&(a.send=a.sendAsBinary);return a},success:function(a){g.http_response(a)},error:function(a,b,d){g.http_error(a,
+b,d,null,"attachment")}})},k=this.env.filedrop.single?0:b.length-1,m=a=0,l;a<=k&&(l=b[m]);m++)if(l.name||(l.name=l.fileName),l.size||(l.size=l.fileSize),l.type||(l.type="application/octet-stream"),!d&&/[^\x20-\x7E]/.test(l.name)&&(l.name_bin=unescape(encodeURIComponent(l.name))),!this.env.filedrop.filter||l.type.match(new RegExp(this.env.filedrop.filter))){if(d){if(d.append(e,l),a==k)return n()}else if(window.FileReader){var p=new FileReader;p.onload=function(a,b){return function(d){h+='Content-Disposition: form-data; name="'+
 e+'"';h+='; filename="'+(l.name_bin||a.name)+'"\r\n';h+="Content-Length: "+a.size+"\r\n";h+="Content-Type: "+a.type+"\r\n\r\n";h+=p.result+"\r\n";h+="--"+f+"\r\n";if(b==k)return n()}}(l,a);p.readAsBinaryString(l)}else if(l.getAsBinary&&(h+='Content-Disposition: form-data; name="'+e+'"',h+='; filename="'+(l.name_bin||l.name)+'"\r\n',h+="Content-Length: "+l.size+"\r\n",h+="Content-Type: "+l.type+"\r\n\r\n",h+=l.getAsBinary()+"\r\n",h+="--"+f+"\r\n",a==k))return n();a++}};this.start_keepalive=function(){!this.env.session_lifetime||
 this.env.framed||this.env.extwin||"login"==this.task||"print"==this.env.action||(this._keepalive&&clearInterval(this._keepalive),this._keepalive=setInterval(function(){g.keep_alive()},500*this.env.session_lifetime))};this.start_refresh=function(){!this.env.refresh_interval||this.env.framed||this.env.extwin||"login"==this.task||"print"==this.env.action||(this._refresh&&clearInterval(this._refresh),this._refresh=setInterval(function(){g.refresh()},1E3*this.env.refresh_interval))};this.keep_alive=function(){this.busy||
 this.http_request("keep-alive")};this.refresh=function(){if(this.busy)setTimeout(function(){g.refresh();g.start_refresh()},1E4);else{var a={},b=this.set_busy(!0,"refreshing");"mail"==this.task&&this.gui_objects.mailboxlist&&(a=this.check_recent_params());a._last=Math.floor(this.env.lastrefresh.getTime()/1E3);this.env.lastrefresh=new Date;this.http_post("refresh",a,b)}};this.check_recent_params=function(){var a={_mbox:this.env.mailbox};this.gui_objects.mailboxlist&&(a._folderlist=1);this.gui_objects.quotadisplay&&
@@ -305,4 +305,4 @@
 this.env.cookie_secure)};this.get_local_storage_prefix=function(){this.local_storage_prefix||(this.local_storage_prefix="roundcube."+(this.env.user_id||"anonymous")+".");return this.local_storage_prefix};this.local_storage_get_item=function(a,b,d){var e,f;try{e=localStorage.getItem(this.get_local_storage_prefix()+a),f=JSON.parse(e)}catch(g){}return f||b||null};this.local_storage_set_item=function(a,b,d){try{return localStorage.setItem(this.get_local_storage_prefix()+a,JSON.stringify(b)),!0}catch(e){return!1}};
 this.local_storage_remove_item=function(a){try{return localStorage.removeItem(this.get_local_storage_prefix()+a),!0}catch(b){return!1}};this.print_dialog=function(){bw.safari?setTimeout("window.print()",10):window.print()}}rcube_webmail.long_subject_title=function(g,v){if(!g.title){var a=$(g);a.width()+15*(v||0)>a.parent().width()&&(g.title=rcube_webmail.subject_text(g))}};
 rcube_webmail.long_subject_title_ex=function(g){if(!g.title){var v=$(g),a=$.trim(v.text()),a=$("<span>").text(a).css({position:"absolute","float":"left",visibility:"hidden","font-size":v.css("font-size"),"font-weight":v.css("font-weight")}).appendTo($("body")),b=a.width();a.remove();b+15*$("span.branch",v).width()>v.width()&&(g.title=rcube_webmail.subject_text(g))}};rcube_webmail.subject_text=function(g){g=$(g).clone();g.find(".skip-on-drag").remove();return g.text()};
-rcube_webmail.prototype.get_cookie=getCookie;rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
+rcube_webmail.prototype.get_cookie=getCookie;rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
\ No newline at end of file
Index: program/lib/Roundcube/rcube_db.php
===================================================================
--- program/lib/Roundcube/rcube_db.php	(revision 64)
+++ program/lib/Roundcube/rcube_db.php	(working copy)
@@ -691,14 +691,11 @@
     {
         // get tables if not cached
         if ($this->tables === null) {
-            $q = $this->query('SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES ORDER BY TABLE_NAME');
+            $q = $this->query("SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES" 
+                . " WHERE TABLE_TYPE = 'BASE TABLE'" 
+                . " ORDER BY TABLE_NAME"); 
 
-            if ($q) {
-                $this->tables = $q->fetchAll(PDO::FETCH_COLUMN, 0);
-            }
-            else {
-                $this->tables = array();
-            }
+            $this->tables = $q ? $q->fetchAll(PDO::FETCH_COLUMN, 0) : array(); 
         }
 
         return $this->tables;
Index: program/lib/Roundcube/rcube_db_mysql.php
===================================================================
--- program/lib/Roundcube/rcube_db_mysql.php	(revision 64)
+++ program/lib/Roundcube/rcube_db_mysql.php	(working copy)
@@ -150,44 +150,30 @@
     }
 
     /**
-     * Get database runtime variables
-     *
-     * @param string $varname Variable name
-     * @param mixed  $default Default value if variable is not set
-     *
-     * @return mixed Variable value or default
-     */
-    public function get_variable($varname, $default = null)
-    {
-        if (!isset($this->variables)) {
-            $this->variables = array();
-        }
+     * Returns list of tables in a database 
+     * 
+     * @return array List of all tables of the current database 
+     */ 
+    public function list_tables() 
+    { 
+        // get tables if not cached 
+        if ($this->tables === null) { 
+            // first fetch current database name 
+            $d = $this->query("SELECT database()"); 
+            $d = $this->fetch_array($d); 
 
-        if (array_key_exists($varname, $this->variables)) {
-            return $this->variables[$varname];
-        }
-
-        // configured value has higher prio
-        $conf_value = rcube::get_instance()->config->get('db_' . $varname);
-        if ($conf_value !== null) {
-            return $this->variables[$varname] = $conf_value;
-        }
-
-        $result = $this->query('SHOW VARIABLES LIKE ?', $varname);
-
-        while ($row = $this->fetch_array($result)) {
-            $this->variables[$row[0]] = $row[1];
-        }
-
-        // not found, use default
-        if (!isset($this->variables[$varname])) {
-            $this->variables[$varname] = $default;
-        }
-
-        return $this->variables[$varname];
-    }
-
-    /**
+            // get list of tables in current database 
+            $q = $this->query("SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES" 
+                . " WHERE TABLE_SCHEMA = ? AND TABLE_TYPE = 'BASE TABLE'" 
+                . " ORDER BY TABLE_NAME", $d ? $d[0] : ''); 
+ 
+            $this->tables = $q ? $q->fetchAll(PDO::FETCH_COLUMN, 0) : array(); 
+        } 
+ 
+        return $this->tables; 
+    } 
+ 
+    /** 
      * Handle DB errors, re-issue the query on deadlock errors from InnoDB row-level locking
      *
      * @param string Query that triggered the error
Index: program/lib/Roundcube/rcube_db_pgsql.php
===================================================================
--- program/lib/Roundcube/rcube_db_pgsql.php	(revision 64)
+++ program/lib/Roundcube/rcube_db_pgsql.php	(working copy)
@@ -158,42 +158,27 @@
     }
 
     /**
-     * Returns PDO DSN string from DSN array
-     *
-     * @param array $dsn DSN parameters
-     *
-     * @return string DSN string
-     */
-    protected function dsn_string($dsn)
-    {
-        $params = array();
-        $result = 'pgsql:';
+     * Returns list of tables in a database 
+     * 
+     * @return array List of all tables of the current database 
+     */ 
+    public function list_tables() 
+    { 
+        // get tables if not cached 
+        if ($this->tables === null) { 
+            $q = $this->query("SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES" 
+                . " WHERE TABLE_TYPE = 'BASE TABLE' AND TABLE_SCHEMA NOT IN ('pg_catalog', 'information_schema')" 
+                . " ORDER BY TABLE_NAME"); 
+ 
+            $this->tables = $q ? $q->fetchAll(PDO::FETCH_COLUMN, 0) : array(); 
+        } 
 
-        if ($dsn['hostspec']) {
-            $params[] = 'host=' . $dsn['hostspec'];
-        }
-        else if ($dsn['socket']) {
-            $params[] = 'host=' . $dsn['socket'];
-        }
-
-        if ($dsn['port']) {
-            $params[] = 'port=' . $dsn['port'];
-        }
-
-        if ($dsn['database']) {
-            $params[] = 'dbname=' . $dsn['database'];
-        }
-
-        if (!empty($params)) {
-            $result .= implode(';', $params);
-        }
-
-        return $result;
-    }
-
+        return $this->tables; 
+    } 
+ 
     /**
-     * Parse SQL file and fix table names according to table prefix
-     */
+      * Parse SQL file and fix table names according to table prefix
+      */
     protected function fix_table_names($sql)
     {
         if (!$this->options['table_prefix']) {
Index: program/lib/Roundcube/rcube_vcard.php
===================================================================
--- program/lib/Roundcube/rcube_vcard.php	(revision 64)
+++ program/lib/Roundcube/rcube_vcard.php	(working copy)
@@ -135,7 +135,10 @@
         $this->firstname    = $this->raw['N'][0][1];
         $this->middlename   = $this->raw['N'][0][2];
         $this->nickname     = $this->raw['NICKNAME'][0][0];
-        $this->organization = $this->raw['ORG'][0][0];
+        for ($i = 0; $i < 3; $i++) {
+          $this->organization = $this->raw['ORG'][0][$i];
+          if ($this->organization) break;
+        }
         $this->business     = ($this->raw['X-ABSHOWAS'][0][0] == 'COMPANY') || (join('', (array)$this->raw['N'][0]) == '' && !empty($this->organization));
 
         foreach ((array)$this->raw['EMAIL'] as $i => $raw_email) {
@@ -530,7 +533,7 @@
     {
         // convert Apple X-ABRELATEDNAMES into X-* fields for better compatibility
         $vcard = preg_replace_callback(
-            '/item(\d+)\.(X-ABRELATEDNAMES)([^:]*?):(.*?)item\1.X-ABLabel:(?:_\$!<)?([\w-() ]*)(?:>!\$_)?./s',
+            '/item(\d+)\.(X-ABRELATEDNAMES)([^:]*?):(.*?)item\1.X-ABLabel:(?:_\$!<)?([\w-() ]*)(?:>!\$_)?./si',
             array('self', 'x_abrelatednames_callback'),
             $vcard);
 
Index: program/steps/mail/autocomplete.inc
===================================================================
--- program/steps/mail/autocomplete.inc	(revision 64)
+++ program/steps/mail/autocomplete.inc	(working copy)
@@ -175,5 +175,9 @@
     }
 }
 
-$OUTPUT->command('ksearch_query_results', $contacts, $search, $reqid);
+$filtered = array();
+foreach ($contacts as $idx => $contact) {
+  $filtered[strtolower($contact['name'])] = $contact;
+}
+$OUTPUT->command('ksearch_query_results', array_values($filtered), $search, $reqid);
 $OUTPUT->send();
